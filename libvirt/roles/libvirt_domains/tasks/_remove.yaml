# ./roles/libvirt_vms/tasks/_remove.yaml

- name: assert that list of vm_specs is defined
  assert:
    that:
      - vm_specs is defined
      - vm_specs | length > 0

- name: Set list to domains to be removed
  ansible.builtin.set_fact:
    vms_to_remove: "{{ vm_specs | map(attribute='name') | list }}"

- name: Force full turn off Domains - since we delete them anyway
  nsys.libvirt.domain_power_state:
    name: "{{ item }}"
    state: shutdown
    force: true
    uri: "{{ uri }}"
  loop: "{{ vms_to_remove }}"

- name: Remove virtual machines
  community.libvirt.virt:
    name: "{{ item }}"
    flags:
    - managed_save
    - snapshots_metadata
    - nvram
    - checkpoints_metadata
    command: undefine
    force: true
    uri: "{{ uri }}"
  loop: "{{ vms_to_remove }}"